
# יומן שינויים

## ‏6.0.0

⚠️ גרסה 6 כוללת **שינויים שוברים משמעותיים** בAPI של הספריה ⚠️

לפני שדרוג פרויקט קיים לגרסה זו יש לוודא שעדכנתם את הקוד הקיים לשינויים השוברים מפורטים להלן:

### **שינויים שוברים:**

- ‫הוסרו המשתנים `call.query` ו-`call.body`, במקומם נוסף המשתנה `call.values` שמכיל את הquery/body בהתאמה, לפי שיטת הפניה מימות - GET או POST.
- הוסרה האפשרות להוסיף פונקציית שיחה ע"י add_fn, שסומנה כמיושנת בגרסה 5.0.0, ניתן להשתמש במקום בget/post/all.
- הוסר המשתנה `call.params`, ניתן להשתמש ב`call.req.params` במקום.
- האפשרות `uncaughtErrorsHandler` שונתה לכתיב הנכון - `uncaughtErrorHandler` (בלי ה-s).
- הפרמטר הבוליאני של `id_list_message` שהגדיר האם לחבר את ההודעות לפעולה הבאה לצורך שרשור פעולות, **הוסר**, ובמקומו יש להעביר אובייקט, עם `prependToNextAction: true`. פרטים נוספים [בתיעוד](#id_list_messagemessages-options).
- ההגדרות בכתיב השגוי `lenght_max` ו-`lenght_max` שהוצאו משימוש בגרסה 5.0.0, הוסרו סופית ולא יעבדו יותר.
- שמות של אופציות רבות בread שלא היו מספיק ברורות שונו, וב2 מהן אף שונתה ברירת המחדל כדי להתאים לברירת המחדל של ימות המשיח.

**להלן פירוט השינויים בשמות האופציות:**

<div dir="rtl" text-align="right">

| שם ההגדרה הישן           | שם ההגדרה החדש                   | סוג           | הערות                                                |
| ------------------------ | -------------------------------- | ------------- | ---------------------------------------------------- |
| `play_ok_mode`           | `typing_playback_mode`           | *️⃣ הקשות       |                                                      |
| `read_none`              | `allow_none`                     | *️⃣ הקשות       |                                                      |
| `read_none_var`          | `none_val`                       | *️⃣ הקשות       |                                                      |
| `block_change_type_lang` | `block_change_keyboard`          | *️⃣ הקשות       |                                                      |
| `min`                    | `min_digits`                     | *️⃣ הקשות       |                                                      |
| `max`                    | `max_digits`                     | *️⃣ הקשות       |                                                      |
| `block_zero`             | `block_zero_key`                 | *️⃣ הקשות       |                                                      |
| `block_asterisk`         | `block_asterisk_key`             | *️⃣ הקשות       |                                                      |
| `record_ok`              | `no_save_menu`                   | 🎙️ הקלטה       | ברירת מחדל **משמיע** תפריט אישור, הפוך מההגדרה הישנה |
| `record_hangup`          | `save_on_hangup`                 | 🎙️ הקלטה       |                                                      |
| `record_attach`          | `append_to_existing_file`        | 🎙️ הקלטה       |                                                      |
| `allow_typing`           | `block_typing`                   | 🗣️ זיהוי דיבור | ברירת מחדל **מאפשר** הקשות, הפוך מההגדרה הישנה       |
| `use_records_engine`     | `use_records_recognition_engine` | 🗣️ זיהוי דיבור |                                                      |

טיפ - ניתן להשתמש בביטוי הרגולרי הבא כדי לבצע חיפוש בכל הפרויקט בתוכנת VSCode, וכך למצוא בקלות הגדרות בשמות הישנים הדורשים טיפול:

```text
play_ok_mode:| read_none:| read_none_var:| block_change_type_lang:| min:| max:| block_zero:| block_asterisk
```

### **תכונות ושיפורים לא שוברים:**

- שיפורים פנימיים משמעותיים המונעים באגים והתנהגויות לא צפויות
- נוסף דגל להסרה שקטה של תווים לא חוקיים מהקראת טקסט - `removeInvalidChars`. ראו פירוט [בתיעוד](#תווים-לא-חוקיים-בהקראת-טקסט).
- נוספה תמיכה להגדרות חסרות באפשרות זיהוי דיבור (stt)
- נוספה מתודת `call.hangup()` (קיצור ל `call.go_to_folder('hangup')`)
- התיעוד עודכן ושופר משמעותית
- ניתן להעביר לאתחול הראוטר אופציות עבור אקספרס ראוטר עצמו - ראה [פירוט בתיעוד express.js](https://expressjs.com/en/api.html#express.router) על האופציות הזמינות.

## ‏5.0.0

גרסה 5 כוללת שינויים רבים, כולל שינויים שוברים, ושכתוב משמעותי של הAPI הפנימי.

**שינויים שוברים עיקריים:**

- ‫שם המחלקה `Yemot_router` הוחלף ל `YemotRouter`

- הפרמטרים מהurl לא מוזרקים אוטומטית לאובייקט הcall, אלא זמינים תחת call.req - `call.req.params`/`call.req.query`, בהתאמה, או בקיצור - `call.params`/`call.query`.

- סוג שגיאה חדש: `InputValidationError` - נפלט כאשר הועבר קלט לא חוקי, למשל השמעת הודעת טקסט המכילה תו נקודה.

- ניתן להשתמש במתודות get/post/all כמו באקספרס רגיל. כרגע מתודת `add_fn` נשמרת לצורך תאימות, אבל מומלץ לעדכן (עדכון: הוסר בגרסה 6).

- ‫`lenght_min` בread מסוג הקלטה תוקן ל`length_min`, כנ"ל `lenght_max` תוקן ל`length_max`. כרגע הכתיב השגוי עדיין נתמך, אבל יוסר בהמשך (הוסר סופית בגרסה 6.0.0).

- שליטה באתחול הראוטר האם יודפסו לוגים פנימיים של הספריה (ברירת מחדל לא - בשונה מבגרסאות הקודמות)

- ‫שמות משתנים הומרו לCamelCase כמקובל, לדוגמה `call_id` הומר ל`callId` וכן הלאה.

בנוסף שיפורים ושינויים רבים לא שוברים, לדוגמה:

- לוג מפורט בהעברת תווים לא חוקיים

- אפשרות העברת מטפל לשגיאות כלליות שלא נתפסו - לא שגיאות פנימיות של הספריה כמו `HangupError`, אלא שגיאה לא צפויה. מאפשר לדוגמה לשלוח מייל למפתח עם לוג מפורט, ולהשמיע למשתמש הודעת שגיאה כללית במקום שהתהליך יקרוס.

- שינויים ושיפורים רבים נוספים מאחורי הקלעים.

### ‏5.0.1

כל הפרמטרים בURL (query params) שמתחילים במילה `Api` (פרמטרים אוטומטיים של ימות), לדוגמה `ApiExtension`, `ApiPhone`, כן מוזרקים אוטומטית לאובייקט הCall.

### ‏5.1.1

תוקן באג שבו ניתוק מחוץ לפונקציה (לדוגמה השמעת id_list_message, יציאה מהשלוחה ואז ניתוק) היה מפעיל את הפונקציה.

### ‏5.1.2

תוקנה התמיכה בבקשות POST (ההגדרה `api_url_post=yes` בשלוחה), שבהן הפרמטרים נשלחים ב`body` ולא ב`query`

נוסף פרוקסי שמיירט נסיון גישה לreq.query בבקשות POST או לreq.body בבקשות GET, ומציג הסבר מפורט לתיקון.

### ‏5.1.3

תוקנה האופציה timeout באתחול הראוטר.

## ‏4.0.0

בגרסה 4.0.0 שינוי משמעותי:

במקום לבדוק בכל פעם את הפרמטר `hangup` כעת בעת ניתוק תיזרק שגיאה פנימית - `HangupError`,

‫ניתן לתפוס אותה להתנהגות מותאמת אישית, כלומר שאם מבקשים נתון על ידי read והמשתמש מנתק, תתבצע פעולה, לדוגמה למחוק רשומות שכבר נוצרו בשיחה.

אם לא תופסים את השגיאת ניתוק, היא תגרום לעצירה של ריצת הפונקציה (**ללא עצירה של התהליך כולו**, כיוון שהשגיאה נתפסת ברמה יותר גבוהה - ע"י הספריה).
